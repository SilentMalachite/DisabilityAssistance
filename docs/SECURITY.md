# セキュリティガイドライン

## 🔐 概要

障害者サービス管理システムは、機微な個人情報を扱うため、最高レベルのセキュリティ対策を実装しています。このドキュメントでは、システムのセキュリティ仕様と、開発・運用時のセキュリティ要件について説明します。

## 📊 セキュリティアーキテクチャ

### データ保護レイヤー

```
┌─────────────────────────────────────┐
│          アプリケーション層           │
├─────────────────────────────────────┤
│        入力検証・サニタイゼーション      │
├─────────────────────────────────────┤
│          認証・認可制御              │
├─────────────────────────────────────┤
│        フィールドレベル暗号化          │
├─────────────────────────────────────┤
│          データベース層              │
├─────────────────────────────────────┤
│           ファイルシステム           │
└─────────────────────────────────────┘
```

## 🛡️ 実装済みセキュリティ対策

### 1. データ暗号化

#### フィールドレベル暗号化
- **アルゴリズム**: AES-256-GCM
- **対象フィールド**: 氏名、住所、電話番号、メールアドレス、障害情報
- **実装場所**: `internal/adapter/crypto/cipher.go`

```go
// 暗号化例
cipher, err := crypto.NewFieldCipher(key)
encrypted, err := cipher.Encrypt("機微情報")
```

#### 鍵管理
- **macOS**: Keychain Services
- **Windows**: Data Protection API (DPAPI)
- **実装**: OS固有のセキュアストレージを使用

### 2. 認証・認可

#### ロールベースアクセス制御 (RBAC)
- **管理者 (admin)**: 全機能へのアクセス
- **職員 (staff)**: 通常業務機能
- **閲覧専用 (readonly)**: 参照のみ

#### パスワードセキュリティ
- **ハッシュ化**: bcrypt (cost: 12)
- **最小要件**: 8文字以上、大文字・小文字・数字を含む
- **実装**: `internal/adapter/crypto/password_hasher.go`

### 3. 入力検証システム

#### 包括的バリデーション (`internal/validation/`)
- **SQL インジェクション防御**: キーワード検出 + パラメータ化クエリ
- **XSS 防御**: HTMLタグ・JavaScriptパターンの検出
- **入力サニタイゼーション**: null バイト・制御文字の除去
- **日本語検証**: ひらがな・カタカナ・漢字の適切な検証

#### 検証対象
- ✅ ログインフォーム
- ✅ 利用者登録・編集フォーム  
- ✅ 職員管理フォーム
- ✅ 受給者証フォーム
- ✅ 検索クエリ

### 4. 監査ログ

#### 記録対象
- 全データアクセス（作成・参照・更新・削除）
- ログイン・ログアウト
- 権限変更
- システム設定変更

#### ログ形式
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "actor_id": "staff-001",
  "action": "UPDATE_RECIPIENT",
  "target": "recipient:123",
  "ip_address": "192.168.1.100",
  "details": "Updated contact information"
}
```

## ⚠️ セキュリティ脅威と対策

### 1. SQLインジェクション
**対策**:
- パラメータ化クエリの使用
- 危険なSQLキーワードの検出
- 入力値のエスケープ処理

### 2. XSS (Cross-Site Scripting)
**対策**:
- HTMLタグの検出と拒否
- JavaScript URLの検出
- イベントハンドラーの検出

### 3. CSRF (Cross-Site Request Forgery)
**対策**:
- CSRFトークンの実装
- リファラーチェック
- SameSite Cookieの使用

### 4. データ漏洩
**対策**:
- フィールドレベル暗号化
- アクセスログの完全記録
- 最小権限の原則

### 5. 内部脅威
**対策**:
- ロールベースアクセス制御
- 全操作の監査ログ
- 定期的なアクセス権限レビュー

## 🔧 開発時のセキュリティ要件

### コーディング規約

#### 入力処理
```go
// 必須: 全ユーザー入力の検証
formValidator := validation.NewFormValidator()
sanitizedInput := formValidator.SanitizeInput(userInput)
if err := formValidator.ValidateInput(field, sanitizedInput); err != nil {
    return err
}
```

#### データベースアクセス
```go
// 必須: パラメータ化クエリの使用
stmt, err := db.Prepare("SELECT * FROM recipients WHERE id = ?")
result, err := stmt.Query(recipientID)
```

#### 機微情報の処理
```go
// 必須: 暗号化してから保存
encryptedData, err := cipher.Encrypt(sensitiveData)
if err != nil {
    return fmt.Errorf("encryption failed: %w", err)
}
```

### テスト要件

#### セキュリティテスト
- 入力検証のテスト (正常値・異常値・境界値)
- SQLインジェクション試行のテスト
- XSS攻撃パターンのテスト
- 認可制御のテスト

#### 暗号化テスト
- 暗号化・復号化の往復テスト
- 不正なキーでの復号化失敗テスト
- 暗号化データの可読性テスト

### コードレビュー

#### セキュリティチェックポイント
- [ ] 入力検証の実装確認
- [ ] SQLクエリのパラメータ化確認
- [ ] 機微情報の暗号化確認
- [ ] 認可制御の実装確認
- [ ] ログ出力にPIIが含まれていないか確認

## 🚨 脆弱性報告

### 報告プロセス

1. **機密報告**: security@your-org.com へメール
2. **詳細情報**: 以下を含める
   - 脆弱性の種類・影響範囲
   - 再現手順
   - 概念実証コード（あれば）
   - 修正提案（あれば）

3. **対応時間**:
   - 24時間以内: 受信確認
   - 72時間以内: 初期評価
   - 30日以内: 修正版リリース

### 脆弱性の評価基準

#### Critical (最重要)
- システム全体の制御権限奪取
- 大量の個人情報漏洩
- 認証回避

#### High (重要)  
- 限定的な権限昇格
- 特定ユーザーの情報漏洩
- サービス拒否攻撃

#### Medium (中程度)
- 情報開示
- 限定的なデータ改ざん

#### Low (軽微)
- 軽微な情報漏洩
- UIの不具合

## 📋 セキュリティチェックリスト

### デプロイ前チェック

#### アプリケーション
- [ ] 最新の依存関係を使用
- [ ] セキュリティテストの実行
- [ ] 静的解析ツールの実行
- [ ] 脆弱性スキャンの実行

#### 設定
- [ ] デフォルトパスワードの変更
- [ ] 不要なサービスの無効化
- [ ] ログ設定の確認
- [ ] バックアップ設定の確認

#### データベース
- [ ] 暗号化設定の確認
- [ ] アクセス権限の設定
- [ ] バックアップの暗号化
- [ ] 接続文字列の保護

### 運用チェック

#### 定期作業
- [ ] セキュリティパッチの適用
- [ ] 監査ログの確認
- [ ] アクセス権限のレビュー
- [ ] バックアップの整合性確認

#### インシデント対応
- [ ] インシデント対応手順の準備
- [ ] 連絡先リストの最新化
- [ ] 復旧手順の文書化
- [ ] 定期的な対応訓練

## 📚 参考資料

### セキュリティ標準
- [OWASP Top 10](https://owasp.org/Top10/)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)
- [個人情報保護法ガイドライン](https://www.ppc.go.jp/)

### 技術仕様
- [Go Security Policy](https://golang.org/security)
- [SQLite Security](https://www.sqlite.org/security.html)
- [Fyne Security](https://fyne.io/security/)

---

**セキュリティは継続的なプロセスです。新しい脅威に対応するため、定期的な見直しと改善を行ってください。**